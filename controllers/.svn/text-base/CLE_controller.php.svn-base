<?php
/*---- Lets make a controller ----*/

class CLE_controller extends Controller {
    function __construct(){
        //echo 'JEG LEVER';
    }

	function index(){
        $topcat = new Category(0);

        $data['description'] = get_string('viewCoursesDescription','block_course_list_export');

        //$data['categories']  = $this->render_cat($topcat);
        $data['categories'] = $this->create_category_array();

        echo $this->view('view_setup.php', $data);
    }

    function generate(){

        $data['header'] = $this->create_header_array();

        $data['content'] = $this->create_list_array();

        echo $this->view('view_list.php', $data);
    }   

    function create_list_array($obj, $depth = 0, $catpath = ''){
        global $list;

        if (!isset($obj)){
            $obj = new Category(0);
        }

        if ($obj instanceof Category){

            if ($obj->id != 0) {
                if ($depth > 1){
                    $catpath .= '/' . $obj->name;
                } else {
                  $catpath .= $obj->name;
                }
            }

            foreach ($obj->courses as $course) {
                $this->create_list_array($course, $depth+1, $catpath);
            }
            foreach ($obj->categories as $category) {
                $this->create_list_array($category, $depth+1, $catpath);
            }
        } elseif ($obj instanceof Course){
            $list[] = $this->create_row_array($obj, $catpath);
        }

        return $list;
    }         
    
    function create_header_array(){

        $title = array();
        $description = array();
        $action = array();

        /*KURSUS ID*/
        $title['id']              = 'KursusID';
        $description['id']        = 'ID på kursus i Moodle. Bruges af Moodle ved tilmelding af STADS-grupper til kurser';
        $action['id']             = 'Denne kolonne kan ikke ændres';
        
        /*KORT NAVN*/
        $title['shortname']       = 'Kort kursusnavn';
        $description['shortname'] = 'Kort navn på kursus på semestret';
        $action['shortname']      = 'Denne kolonne kan ikke ændres';
        
        /*FULDT NAVN*/
        $title['fullname']        = 'Navn på kursus/rum';
        $description['fullname']  = 'Navn på kursus på semestret';
        $action['fullname']       = 'Denne kolonne kan ikke ændres';
        
        /*KATEGORI STI*/
        $title['path']            = 'Kursuskategori';
        $description['path']      = 'Den kursuskategori i Moodle hvor kurset var placeret på semestret';
        $action['path']           = 'Denne kolonne kan ikke ændres';
        
        /*SAMLÆST?*/
        $title['samlaest']        = 'Samlæst modul/kursus';
        $description['samlaest']  = '';
        $action['samlaest']       = 'Hvis modulet/kurset er samlæst, indtast navn på samlæst modul/kursus';
        
        /*KOMMENTAR*/
        $title['kommentar']       = 'Kommentar';
        $description['kommentar'] = '';
        $action['kommentar']      = 'Her kan noteres kommentarer';

        return array('title' => $title, 'description' => $description, 'action' => $action);

    }

    function create_row_array($obj, $catpath){
        $row = array();
        $row['id'] = $obj->idnumber;
        $row['shortname'] = $obj->shortname;
        $row['fullname'] = $obj->fullname;
        $row['path'] = $catpath;
        $row['samlaest'] = '';
        $row['kommentar'] = '';

        return $row;
    }

    function create_category_array($obj, $depth = 0){
        if (!isset($obj)){
            $obj = new Category(0);
        }

        static $cat_list;

        if ($obj instanceof Category){
            $cat_list[] = $obj;

            foreach ($obj->categories as $category){
                $this->create_category_array($category, $depth+1);
            }
        }

        return $cat_list;
    }
}